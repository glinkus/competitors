{% extends 'rarea/layout.html' %}

{% block content %}
  <div class="analyze-heading">
    <h1 class="analyze-heading">Analyze competitors website</h1>
  </div>
  <div class="analyze-heading">
    <h2 class="analyze-heading">Select website page from the list to see analysis below</h2>
  </div>
  <div class="container py-5">
    <div class="mb-4">
      <label for="pageDropdown" class="form-label">Select Page:</label>
      <select id="pageDropdown" class="form-select">
        <option value="">-- Select a page --</option>
        {% for page in pages %}
          <option value="{{ page.id }}">{{ page.url }}</option>
        {% endfor %}
      </select>
    </div>
  
    <!-- Keywords Section -->
    <div id="keywordsDisplay" class="mb-5">
      <h5 class="table-title">Keywords for Selected Page:</h5>
      <ul id="keywordList" class="list-group"></ul>
    </div>
  
    <!-- SEO Details -->
    <div id="seoDetails" class="d-none">
      <div class="mb-4">
        <h5 class="table-title">SEO Score</h4>
        <div class="progress">
          <div id="seoScoreBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
        </div>
      </div>
  
      <div class="row mb-4">
        <div class="col-md-6">
          <h5 class="table-title">Warnings</h5>
          <ul id="warningList" class="list-group"></ul>
        </div>
        <div class="col-md-6">
          <h5 class="table-title">Linking Analysis</h5>
          <pre id="linkingAnalysis" class="bg-light custom-p-3 rounded border"></pre>
        </div>
      </div>
  
      <div class="mb-4">
        <h5 class="table-title">SEO Score Details</h5>
        <pre id="seoScoreDetails" class="seo-score-box"></pre>
      </div>
  
      <div class="mb-4">
        <h5 class="table-title">Recommendations</h5>
        <div id="recommendationsContainer"></div>
      </div>
    </div>
  </div>
  
  <script>
    const keywordsByPage = {{ keywords_by_page|safe }};
    const pageData = {{ pages_json|safe }};
    const recommendations = {{ recommendations_json|safe }};
  
    const dropdown = document.getElementById("pageDropdown");
    const keywordList = document.getElementById("keywordList");
    const seoDetails = document.getElementById("seoDetails");
    const seoScoreBar = document.getElementById("seoScoreBar");
    const warningList = document.getElementById("warningList");
    const linkingAnalysis = document.getElementById("linkingAnalysis");
    const seoScoreDetails = document.getElementById("seoScoreDetails");
    const recommendationsContainer = document.getElementById("recommendationsContainer");
  
    dropdown.addEventListener("change", function () {
      const selectedId = this.value;
  
      // Clear all sections
      keywordList.innerHTML = "";
      warningList.innerHTML = "";
      linkingAnalysis.textContent = "";
      seoScoreDetails.textContent = "";
      recommendationsContainer.innerHTML = "";
  
      if (!selectedId || !pageData[selectedId]) {
        seoDetails.classList.add("d-none");
        return;
      }
  
      // Show SEO details
      seoDetails.classList.remove("d-none");
  
      const data = pageData[selectedId];
  
      // SEO Score
      const score = data.seo_score || 0;
      seoScoreBar.style.width = score + "%";
      seoScoreBar.innerText = score + "%";
      seoScoreBar.classList.remove("bg-success", "bg-warning", "bg-danger");
      seoScoreBar.classList.add(
        score >= 70 ? "bg-success" :
          score >= 40 ? "bg-warning" :
            "bg-danger"
      );

      let warnings = data.warnings;
      if (typeof warnings === "string") {
        try {
          warnings = JSON.parse(warnings);
        } catch (e) {
          console.error("Failed to parse warnings JSON:", e);
          warnings = [];
        }
      }
      (warnings || []).forEach(w => {
        const li = document.createElement("li");
        li.classList.add("list-group-item", "text-danger");
        li.innerText = w;
        warningList.appendChild(li);
      });

  
      // Linking Analysis
      const linking = data.linking_analysis || {};
      let html = "";

      if (Object.keys(linking).length === 0) {
        html = "<p class='text-muted'>No linking data available.</p>";
      } else {
        html += `
          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong>Internal Linking Score</strong>
              <span class="badge bg-primary rounded-pill">${linking.internal_linking_score ?? 'N/A'}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong>External Linking Score</strong>
              <span class="badge bg-primary rounded-pill">${linking.external_linking_score ?? 'N/A'}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong>Anchor Text Score</strong>
              <span class="badge bg-primary rounded-pill">${linking.anchor_text_score ?? 'N/A'}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong>Overall Linking Score</strong>
              <span class="badge bg-primary rounded-pill">${linking.overall_linking_score ?? 'N/A'}</span>
            </li>
          </ul>
        `;

        if (Array.isArray(linking.linking_recommendations) && linking.linking_recommendations.length > 0) {
          html += `<h6 class="table-title">Recommendations:</h6><ul class="list-group">`;
          linking.linking_recommendations.forEach(rec => {
            html += `<li class="list-group-item">${rec}</li>`;
          });
          html += `</ul>`;
        }
      }

      linkingAnalysis.innerHTML = html;

  
      // Score Details
      const details = data.seo_score_details || {};
      let seoHtml = "";

      if (!Object.keys(details).length) {
        seoHtml = "<p class='text-muted'>No SEO score details available.</p>";
      } else {
        seoHtml += `
          <div class="section-block">
            <strong>SEO Score:</strong>
            <span class="badge">${details.seo_score ?? 'N/A'}</span>
          </div>
        `;

        if (details.strengths?.length) {
          seoHtml += `
            <div class="mb-3">
              <h6 class="text-success">Strengths</h6>
              <ul class="list-group list-group-flush">
                ${details.strengths.map(item => `<li class="list-group-item text-success">${item}</li>`).join("")}
              </ul>
            </div>
          `;
        }

        if (details.weaknesses?.length) {
          seoHtml += `
            <div class="mb-3">
              <h6 class="text-danger">Weaknesses</h6>
              <ul class="list-group list-group-flush">
                ${details.weaknesses.map(item => `<li class="list-group-item text-danger">${item}</li>`).join("")}
              </ul>
            </div>
          `;
        }

        if (details.recommendations?.length) {
          seoHtml += `
            <div class="mb-3">
              <h6 class="text-primary">Recommendations</h6>
              <ul class="list-group list-group-flush">
                ${details.recommendations.map(item => `<li class="list-group-item">${item}</li>`).join("")}
              </ul>
            </div>
          `;
        }
      }

      seoScoreDetails.innerHTML = seoHtml;

  
      // Recommendations
      const recs = recommendations[selectedId] || [];
      recs.forEach(rec => {
        const card = document.createElement("div");
        card.className = "card mb-3";
        card.innerHTML = `
          <div class="card-body">
            <h6 class="card-title text-primary">${rec.category.replace(/_/g, ' ')}</h6>
            <p class="card-text"><strong>Rationale:</strong> ${rec.rationale || "N/A"}</p>
            <ul class="mb-0">${(rec.actions || []).map(action => `<li>${action}</li>`).join('')}</ul>
          </div>
        `;
        recommendationsContainer.appendChild(card);
      });
  
      // Keywords
      const keywords = keywordsByPage[selectedId] || [];
      if (keywords.length) {
        keywords.forEach(kw => {
          const li = document.createElement("li");
          li.textContent = kw;
          li.classList.add("list-group-item");
          keywordList.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        li.textContent = "No keywords found for this page.";
        li.classList.add("list-group-item", "text-muted");
        keywordList.appendChild(li);
      }
    });
  </script>
  
{% endblock %}
