{% extends 'rarea/layout.html' %}
{% load static %}

{% block content %}
<div class="container py-5 overview-container">
    <div class="analyze-heading">
        <h1 class="analyze-heading">Overview of the company</h1>
    </div>
    <div class="analyze-heading pb-5">
        <h2 class="analyze-heading">{{ website.start_url }}</h1>
    </div>
    <div class="d-flex justify-content-center">
        <h4 class="table-title">Summary</h4>
    </div>
    <div id="executive-summary-loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Generating executive summary...</p>
    </div>

    <div id="executive-summary" class="d-none bg-white shadow rounded p-4 prose">
        <p id="executive-summary-text" style="white-space: pre-line;"></p>
    </div>
    <div class="d-flex justify-content-center">
        <h4 class="table-title p-5">Detailed analysis</h4>
    </div>
    <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
            <h5 class="table-title">Median Text Type Scores</h5>
            <div style="width: 100%; max-width: 500px;" class="chart-container">
                <canvas id="toneChart"></canvas>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-circle readability">
                <strong>{{ avg_readability }}</strong>
                <span>Avg. Readability</span>
                <div class="tooltip-box">
                    <table>
                        <tr>
                            <td>90‚Äì100</td>
                            <td>Very Easy</td>
                        </tr>
                        <tr>
                            <td>80‚Äì89</td>
                            <td>Easy</td>
                        </tr>
                        <tr>
                            <td>70‚Äì79</td>
                            <td>Fairly Easy</td>
                        </tr>
                        <tr>
                            <td>60‚Äì69</td>
                            <td>Standard</td>
                        </tr>
                        <tr>
                            <td>50‚Äì59</td>
                            <td>Fairly Difficult</td>
                        </tr>
                        <tr>
                            <td>30‚Äì49</td>
                            <td>Difficult</td>
                        </tr>
                        <tr>
                            <td>0‚Äì29</td>
                            <td>Very Confusing</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="stat-circle reading-time">
                <strong>{{ avg_reading_time }}</strong>
                <span>Avg. Reading Time</span>
            </div>
        </div>

    </div>
    <div class="mt-10 mb-4">
        <h5 class="table-title pt-5 pb-3">Text Type Score Per Page</h5>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;" class="mb-4">
            <div>
                <label for="tonePageType" class="block mb-1 font-semibold">Text Type</label>
                <select id="tonePageType" class="form-select">
                    <option value="technical">Technical</option>
                    <option value="emotional">Emotional</option>
                    <option value="neutral">Neutral</option>
                </select>
            </div>
            <div>
                <label for="tonePageChartType" class="block mb-1 font-semibold">Chart Style</label>
                <select id="tonePageChartType" class="form-select">
                    <option value="line">Line</option>
                    <option value="bar">Bar</option>
                </select>
            </div>
            <button id="renderTonePageChart" class="button-analyze">Generate</button>
        </div>

        <canvas id="tonePageChart" height="120" class="chart-container"></canvas>
    </div>

    <div class="mt-10 p-3">
        <h5 class="table-title">Reading Time per Page</h5>
        <canvas id="readingTimeChart" height="150" class="chart-container"></canvas>
    </div>

    <div class="mt-10 p-3">
        <h5 class="table-title">Readability Score per Page</h5>
        <canvas id="readabilityChart" height="150" class="chart-container"></canvas>
    </div>
    
    <div class="mt-5">
        <h5 class="table-title pb-2">Top Keywords</h5>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            {% for item in keyword_summary %}
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">
                            <a href="#" class="text-decoration-none text-primary" data-keyword-index="{{ forloop.counter0 }}">
                                {{ item.keyword }}
                            </a>
                        </h6>
                        <p class="mb-2"><strong>Appeared in </strong> {{ item.count }} pages</p>
                        <p class="mb-2"><strong>Google Trends score: </strong>{{ item.trend_score }}</p>
                        <div id="trend-container-{{ forloop.counter }}" class="d-none">
                            <canvas id="trendChart{{ forloop.counter }}" height="120"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="mt-5">
        <h5 class="table-title">Average Page Load Metrics</h5>
        <ul class="list-group list-group-flush">
          <li class="list-group-item">‚è±Ô∏è Time to First Byte: <strong>{{ avg_ttfb }} ms</strong></li>
          <li class="list-group-item">üå∏ First Contentful Paint: <strong>{{ avg_fcp }} ms</strong></li>
          <li class="list-group-item">üèîÔ∏è Largest Contentful Paint: <strong>{{ avg_lcp }} ms</strong></li>
          <li class="list-group-item">‚úÖ Fully Loaded: <strong>{{ avg_loaded }} ms</strong></li>
        </ul>
    </div>

    <div class="mt-5 mb-4">
        <h5 class="table-title">Page Load Speed per Page</h5>
        <div class="d-flex gap-3 align-items-end flex-wrap mb-3">
            <div>
                <label for="metricTypeSelect" class="form-label">Metric</label>
                <select id="metricTypeSelect" class="form-select">
                    <option value="ttfb">Time To First Byte</option>
                    <option value="fcp">First Contentful Paint</option>
                    <option value="lcp">Largest Contentful Paint</option>
                    <option value="loaded">Fully Loaded</option>
                </select>
            </div>
            <div>
                <label for="metricChartStyleSelect" class="form-label">Chart Type</label>
                <select id="metricChartStyleSelect" class="form-select">
                    <option value="line">Line</option>
                    <option value="bar">Bar</option>
                </select>
            </div>
            <button id="renderSpeedChartBtn" class="button-analyze">Generate</button>
        </div>
        <canvas id="loadingMetricChart" height="120" class="chart-container"></canvas>
    </div>

    <h5 class="table-title pb-2 pr-2 pt-5">Target audience of company</h5>
    <div id="target-audience-loading" class="text-center my-4">
        <div class="spinner-border text-secondary" role="status"></div>
        <p class="mt-2">Detecting target audience...</p>
    </div>

    <ul id="target-audience-list" class="space-y-3 d-none"></ul>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.loadLabels = {{ load_labels|safe }};
        window.loadTTFB = {{ load_ttfb|safe }};
        window.loadFCP = {{ load_fcp|safe }};
        window.loadLCP = {{ load_lcp|safe }};
        window.loadFullyLoaded = {{ load_loaded|safe }};
        window.toneData = {{ tone_data | safe }};
        window.tpyeLabels = {{ tone_labels | safe }};
        window.typeData = {{ tone_data | safe }};

        window.speedMetrics = [
            { key: "ttfb", values: {{ load_ttfb|safe }} },
            { key: "fcp", values: {{ load_fcp|safe }} },
            { key: "lcp", values: {{ load_lcp|safe }} },
            { key: "loaded", values: {{ load_loaded|safe }} }
        ];
        window.pageUrls = {{ load_labels|safe }};

        window.toneLabels = {{ reading_labels | safe }};
        const perPageTones = {{ per_page_tones | safe }};

        window.toneMetrics = ["technical", "emotional", "neutral"].map(type => ({
            key: type,
            values: perPageTones.map(p => p[type] ?? 0)
        }));

        window.readingLabels = {{ reading_labels | safe }};
        window.perPageTones = {{ per_page_tones | safe }};
        window.readingValues = {{ reading_values | safe }};
        window.readabilityValues = {{ readability_values | safe }};

        window.keywordData = {{ keyword_summary|safe }};

        const checkInsightReady = () => {
            fetch("{% url 'modules.analysis:website-insight-status' website.id %}")
                .then(res => res.json())
                .then(data => {
                    if (data.ready) {
                        document.getElementById("executive-summary-loading").classList.add("d-none");
                        document.getElementById("executive-summary").classList.remove("d-none");

                        const html = marked.parse(data.insight);
                        document.getElementById("executive-summary-text").innerHTML = html;
                    } else {
                        setTimeout(checkInsightReady, 3000);
                    }
                });
        };

        checkInsightReady();


        const checkAudienceReady = () => {
            fetch("{% url 'modules.analysis:target_audience_status' website.id %}")
                .then(res => res.json())
                .then(data => {
                    if (data.ready) {
                        const listEl = document.getElementById("target-audience-list");
                        const loadingEl = document.getElementById("target-audience-loading");
                        loadingEl.classList.add("d-none");
                        listEl.classList.remove("d-none");

                        const audience = data.audience;
                        listEl.innerHTML = "";

                        for (const [segment, explanation] of Object.entries(audience)) {
                            const li = document.createElement("li");
                            li.className = "bg-white shadow rounded p-3 m-2";
                            li.innerHTML = `<strong>${segment}:</strong> <span class="text-muted">${explanation}</span>`;
                            listEl.appendChild(li);
                        }
                    } else {
                        setTimeout(checkAudienceReady, 3000);
                    }
                });
        };

        checkAudienceReady();

        
    </script>
    
    <div class="modal fade" id="keywordTrendModal" tabindex="-1" aria-labelledby="keywordTrendModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered limited-width">
            <div class="modal-content justify-content-center">
                <div class="modal-header">
                    <h5 class="modal-title" id="keywordTrendModalLabel">Keyword Trend</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <canvas id="trendChartModal" height="120" class="mb-4"></canvas>
                    <h6 class="mt-4">Interest by Region</h6>
                    <canvas id="regionChartModal" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}