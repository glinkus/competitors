{% extends 'rarea/layout.html' %}
{% load static %}

{% block content %}
<div class="container py-5 overview-container">
    <div class="analyze-heading">
        <h1 class="analyze-heading">Overview of the company</h1>
    </div>
    <div class="analyze-heading pb-5">
        <h2 class="analyze-heading">{{ website.start_url }}</h1>
    </div>
    <div class="d-flex justify-content-center">
        <h4 class="table-title">Summary</h4>
    </div>
    <div id="executive-summary-loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Generating executive summary...</p>
    </div>

    <div id="executive-summary" class="d-none bg-white shadow rounded p-4 prose">
        <p id="executive-summary-text" style="white-space: pre-line;"></p>
    </div>
    <div class="d-flex justify-content-center">
        <h4 class="table-title p-5">Detailed analysis</h4>
    </div>
    <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
            <h5 class="table-title">Median Text Type Scores</h5>
            <div style="width: 100%; max-width: 500px;" class="chart-container">
                <canvas id="toneChart"></canvas>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-circle readability">
                <strong>{{ avg_readability }}</strong>
                <span>Avg. Readability</span>
                <div class="tooltip-box">
                    <table>
                        <tr>
                            <td>90–100</td>
                            <td>Very Easy</td>
                        </tr>
                        <tr>
                            <td>80–89</td>
                            <td>Easy</td>
                        </tr>
                        <tr>
                            <td>70–79</td>
                            <td>Fairly Easy</td>
                        </tr>
                        <tr>
                            <td>60–69</td>
                            <td>Standard</td>
                        </tr>
                        <tr>
                            <td>50–59</td>
                            <td>Fairly Difficult</td>
                        </tr>
                        <tr>
                            <td>30–49</td>
                            <td>Difficult</td>
                        </tr>
                        <tr>
                            <td>0–29</td>
                            <td>Very Confusing</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="stat-circle reading-time">
                <strong>{{ avg_reading_time }}</strong>
                <span>Avg. Reading Time</span>
            </div>
        </div>

    </div>
    <div class="mt-10 mb-4">
        <h5 class="table-title pt-5 pb-3">Text Type Score Per Page</h5>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;" class="mb-4">
            <div>
                <label for="tonePageType" class="block mb-1 font-semibold">Text Type</label>
                <select id="tonePageType" class="form-select">
                    <option value="technical">Technical</option>
                    <option value="emotional">Emotional</option>
                    <option value="neutral">Neutral</option>
                </select>
            </div>
            <div>
                <label for="tonePageChartType" class="block mb-1 font-semibold">Chart Style</label>
                <select id="tonePageChartType" class="form-select">
                    <option value="line">Line</option>
                    <option value="bar">Bar</option>
                </select>
            </div>
            <button id="renderTonePageChart" class="button-analyze">Generate</button>
        </div>

        <canvas id="tonePageChart" height="120" class="chart-container"></canvas>
    </div>

    <div class="mt-10 p-3">
        <h5 class="table-title">Reading Time per Page</h5>
        <canvas id="readingTimeChart" height="150" class="chart-container"></canvas>
    </div>

    <div class="mt-10 p-3">
        <h5 class="table-title">Readability Score per Page</h5>
        <canvas id="readabilityChart" height="150" class="chart-container"></canvas>
    </div>

    <div class="mt-5">
        <h5 class="table-title pb-2">Top Keywords</h5>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            {% for item in keyword_summary %}
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">
                            <a href="#" class="text-decoration-none text-primary"
                                onclick="openKeywordModal({{ forloop.counter0 }})">
                                {{ item.keyword }}
                            </a>
                        </h6>
                        <p class="mb-2"><strong>Count:</strong> {{ item.count }}</p>
                        <div id="trend-container-{{ forloop.counter }}" class="d-none">
                            <canvas id="trendChart{{ forloop.counter }}" height="120"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>


    <h5 class="table-title pb-2 pr-2 pt-5">Target audience of company</h5>
    <div id="target-audience-loading" class="text-center my-4">
        <div class="spinner-border text-secondary" role="status"></div>
        <p class="mt-2">Detecting target audience...</p>
    </div>

    <ul id="target-audience-list" class="space-y-3 d-none"></ul>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.toneLabels = {{ tone_labels | safe }};
        window.toneData = {{ tone_data | safe }};
        window.readingLabels = {{ reading_labels | safe }};
        window.perPageTones = {{ per_page_tones | safe }};
        window.readingValues = {{ reading_values | safe }};
        window.readabilityValues = {{ readability_values | safe }};
        const checkInsightReady = () => {
            fetch("{% url 'modules.analysis:website-insight-status' website.id %}")
                .then(res => res.json())
                .then(data => {
                    if (data.ready) {
                        document.getElementById("executive-summary-loading").classList.add("d-none");
                        document.getElementById("executive-summary").classList.remove("d-none");

                        const html = marked.parse(data.insight);
                        document.getElementById("executive-summary-text").innerHTML = html;
                    } else {
                        setTimeout(checkInsightReady, 3000);
                    }
                });
        };

        checkInsightReady();


        const checkAudienceReady = () => {
            fetch("{% url 'modules.analysis:target_audience_status' website.id %}")
                .then(res => res.json())
                .then(data => {
                    if (data.ready) {
                        const listEl = document.getElementById("target-audience-list");
                        const loadingEl = document.getElementById("target-audience-loading");
                        loadingEl.classList.add("d-none");
                        listEl.classList.remove("d-none");

                        const audience = data.audience;
                        listEl.innerHTML = "";

                        for (const [segment, explanation] of Object.entries(audience)) {
                            const li = document.createElement("li");
                            li.className = "bg-white shadow rounded p-3 m-2";
                            li.innerHTML = `<strong>${segment}:</strong> <span class="text-muted">${explanation}</span>`;
                            listEl.appendChild(li);
                        }
                    } else {
                        setTimeout(checkAudienceReady, 3000);
                    }
                });
        };

        checkAudienceReady();
    </script>
    <script>
        const keywordData = {{ keyword_summary| safe }};

        function openKeywordModal(index) {
            const data = keywordData[index];
            const modalTitle = document.getElementById("keywordTrendModalLabel");
            modalTitle.textContent = `Keyword: ${data.keyword}`;

            if (window.trendChartInstance) window.trendChartInstance.destroy();
            if (window.regionChartInstance) window.regionChartInstance.destroy();

            const trendCtx = document.getElementById("trendChartModal").getContext("2d");
            window.trendChartInstance = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: JSON.parse(data.trend_keys),
                    datasets: [{
                        label: 'Trend over time',
                        data: JSON.parse(data.trend_values),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { ticks: { maxTicksLimit: 6 } },
                        y: { beginAtZero: true }
                    }
                }
            });

            const regionData = data.interest_by_region || {};
            const regionLabels = Object.keys(regionData);
            const regionValues = Object.values(regionData);

            const regionCtx = document.getElementById("regionChartModal").getContext("2d");
            window.regionChartInstance = new Chart(regionCtx, {
                type: 'pie',
                data: {
                    labels: regionLabels,
                    datasets: [{
                        data: regionValues,
                        backgroundColor: regionLabels.map(() => `hsl(${Math.random() * 360}, 60%, 70%)`),
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            const modal = new bootstrap.Modal(document.getElementById('keywordTrendModal'));
            modal.show();
        }
    </script>

    <div class="modal fade" id="keywordTrendModal" tabindex="-1" aria-labelledby="keywordTrendModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="keywordTrendModalLabel">Keyword Trend</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <canvas id="trendChartModal" height="120" class="mb-4"></canvas>
                    <h6 class="mt-4">Interest by Region</h6>
                    <canvas id="regionChartModal" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}