{% extends 'rarea/layout.html' %}
{% load i18n %}

{% block content %}
<div class="analyze-heading">
  <h1 class="analyze-heading">Analyze your competitors</h1>
</div>
<div class="analyze-heading">
  <h2 class="analyze-heading">Enter your competitors website url and receive analysis or select already prepared
    analysis from the list</h2>
</div>

<div class="container my-5">
  <div class="card mb-4 shadow-sm analysis">
    <div class="card-body analysis">
      <form action="{% url 'modules.analysis:analyse' %}" method="post" class="row g-3 align-items-center analysis">
        {% csrf_token %}
        <div class="col-sm-9">
          <input type="url" class="form-control" name="url" placeholder="https://example.com" required>
        </div>
        <div class="col-sm-3 text-end">
          <button type="submit" class="button-analyze">Start Analysis</button>
        </div>
      </form>
    </div>
  </div>
  <div class="row mb-4" id="filter-form">
    <div class="col-md-3">
      <select id="status-filter" class="form-select">
        <option value="">All statuses</option>
        <option value="finished">Finished</option>
        <option value="stopped">Stopped</option>
        <option value="in_progress">In Progress</option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="sort-filter" class="form-select">
        <option value="desc">Last Visited (Newest first)</option>
        <option value="asc">Last Visited (Oldest first)</option>
      </select>
    </div>
  </div>
   
  <div class="container my-5">
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for website in websites %}
      <div class="col" id="website-row-{{ website.id }}">
        <div class="card h-100 shadow-sm position-relative border-0" data-id="{{ website.id }}">
          <div class="form-check position-absolute top-0 end-0 m-2 d-none compare-check">
            <input class="form-check-input" type="checkbox" value="{{ website.id }}">
          </div>

          {% if website.favicon_url %}
          <div class="d-flex justify-content-center align-items-center">
            <img src="{{ website.favicon_url }}" class="card-img-top p-3" alt="Favicon"
              style="width: 48px; height: 48px; object-fit: contain;">
          </div>
          {% else %}
          <div class="p-3 text-center text-muted">No Icon</div>
          {% endif %}

          <div class="card-body d-flex flex-column">
            <h6 class="card-title text-truncate" title="{{ website.start_url }}">
              <a href="{{ website.start_url }}" class="text-decoration-none" target="_blank">
                {{ website.start_url }}
              </a>
            </h6>
            <p class="mb-1 visited-count"><strong>Pages:</strong> {{ website.visited_count }}</p>
            <p class="mb-2"><strong>Last Visited:</strong> {{ website.last_visited }}</p>

            {% if website.crawling_finished %}
            <span class="badge bg-success mb-3 status">游릭 Finished</span>
            <div class="mt-auto d-grid gap-2 action">
              <a href="{% url 'modules.analysis:website_page' website.id %}" class="btn btn-outline-primary btn-sm">
                Pages overview
              </a>
              <a href="{% url 'modules.analysis:overview' website.id %}" class="btn btn-outline-dark btn-sm">
                Website overview
              </a>
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteWebsite({{ website.id }})">
                Delete
              </button>
            </div>


            {% elif website.scraping_stopped %}
            <span class="badge bg-danger text-dark mb-3 status">游댮 Stopped</span>
            <div class="mt-auto d-grid gap-2 action">
              <button onclick="continueScraping({{ website.id }})" class="btn btn-primary btn-sm">Continue Scraping</button>
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteWebsite({{ website.id }})">
                Delete Website
              </button>
            </div>
            
            {% elif website.crawling_in_progress and not website.crawling_finished %}
            <span class="badge bg-warning text-dark mb-3 status">游리 In Progress</span>
            <button id="stop-btn-{{ website.id }}" onclick="stopScraping({{ website.id }})"
              class="btn btn-danger btn-sm mb-2">Stop Scraping</button>
            <p id="scraping-stopped-{{ website.id }}" class="text-danger d-none">Scraping was stopped.</p>
            
            {% else %}
            <span class="badge bg-danger mb-3 status">游댮 Not Started</span>
            {% endif %}

          </div>
        </div>
      </div>
      {% empty %}
      <p class="text-center text-muted">No websites added yet.</p>
      {% endfor %}
    </div>
  </div>
  <form class="compare" id="compare-form" action="{% url 'modules.analysis:compare' %}" method="get">
    <button id="start-compare-btn" type="button" class="button-logout m-2">Select websites to compare</button>

    <button id="compare-btn" type="submit" class="compare-selected m-2" hidden>Compare</button>
    <input type="hidden" name="ids" id="compare-ids" value="">
</div>
<script>
  function checkScrapingStatus(websiteId) {
    fetch(`/analysis/analyse/?website_id=${websiteId}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(response => response.json())
      .then(data => {
        const card = document.getElementById(`website-row-${websiteId}`);
        const visitedEl = card.querySelector('.visited-count');
        const statusEl = card.querySelector('.status');
        const actionEl = card.querySelector('.action');
        const stopBtn = card.querySelector(`#stop-btn-${websiteId}`);
        const stoppedMsg = card.querySelector(`#scraping-stopped-${websiteId}`);

        if (visitedEl) {
          visitedEl.innerHTML = `<strong>Pages:</strong> ${data.visited_count}`;
        }

        if (data.crawling_finished) {
          statusEl.innerHTML = '游릭 Finished';
          statusEl.className = 'badge bg-success mb-3 status';

          if (stopBtn) stopBtn.remove();
          if (stoppedMsg) stoppedMsg.classList.add('d-none');

          actionEl.innerHTML = `
            <a href="/analysis/website_page/${websiteId}/" class="btn btn-outline-primary btn-sm">
              Pages overview
            </a>
            <a href="/analysis/overview/${websiteId}/" class="btn btn-outline-dark btn-sm">
              Website overview
            </a>
          `;
        }

        else if (data.crawling_in_progress) {
          statusEl.innerHTML = '游리 In Progress';
          statusEl.className = 'badge bg-warning text-dark mb-3 status';
          setTimeout(() => checkScrapingStatus(websiteId), 2000);
        }
      })
      .catch(error => console.error("Error checking status for website " + websiteId, error));
  }


  function stopScraping(websiteId) {
    fetch(`/analysis/stop-scraping/${websiteId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.stopped) {
        location.reload();
      }
    })
    .catch(error => {
      console.error("Failed to stop scraping:", error);
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (const cookie of cookies) {
        const trimmed = cookie.trim();
        if (trimmed.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function continueScraping(websiteId) {
    fetch(`/analysis/continue-scraping/${websiteId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.continued) {
          location.reload();
        }
      })
      .catch(error => {
        console.error("Failed to continue scraping:", error);
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const websiteCards = document.querySelectorAll('[id^="website-row-"]');
    websiteCards.forEach(card => {
      const websiteId = card.id.replace('website-row-', '');
      const statusEl = card.querySelector('.status');
      if (statusEl && statusEl.innerText.includes("In Progress")) {
        checkScrapingStatus(websiteId);
      }
    });
  });
  function deleteWebsite(websiteId) {
    if (!confirm("Are you sure you want to delete this website?")) {
      return;
    }

    fetch("{% url 'modules.analysis:analyse' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: `delete_website_id=${websiteId}`
    })
      .then(response => response.json())
      .then(data => {
        if (data.deleted) {
          const websiteRow = document.getElementById(`website-row-${websiteId}`);
          if (websiteRow) {
            websiteRow.classList.add('fade-out');
            setTimeout(() => {
              websiteRow.remove();
            }, 500);
          }
        } else {
          alert('Failed to delete the website.');
        }
      })
      .catch(error => {
        console.error('Error deleting website:', error);
      });
  }

</script>
<script>
  let compareMode = false;
  const startBtn = document.getElementById('start-compare-btn');
  const compareBtn = document.getElementById('compare-btn');
  const compareIdsInput = document.getElementById('compare-ids');
  const cards = document.querySelectorAll('.card[data-id]');

  function updateCompareState() {
    const checked = [...document.querySelectorAll('.compare-check input:checked')];
    compareBtn.disabled = checked.length !== 2;
    compareIdsInput.value = checked.map(cb => cb.value).join(',');
  }

  startBtn.addEventListener('click', () => {
    compareMode = !compareMode;
    startBtn.textContent = compareMode ? 'Cancel Compare' : 'Select websites to compare';

    cards.forEach(card => {
      const checkWrapper = card.querySelector('.compare-check');
      const checkbox = checkWrapper.querySelector('input');
      const badge = card.querySelector('.status');

      checkWrapper.classList.toggle('d-none', !compareMode);
      checkbox.checked = false;

      if (compareMode) {
        if (badge.innerText.includes('Finished') || badge.innerText.includes('游릭')) {
          checkbox.disabled = false;
        } else {
          checkbox.disabled = true;
        }
      } else {
        checkbox.disabled = false;
      }
    });

    compareBtn.hidden = !compareMode;
    compareBtn.disabled = true;
    compareIdsInput.value = '';
  });


  cards.forEach(card => {
    const checkbox = card.querySelector('.compare-check input');
    checkbox.addEventListener('change', () => {
      const checked = [...document.querySelectorAll('.compare-check input:checked')];

      if (checked.length > 2) {
        checkbox.checked = false;
        alert('You can compare a maximum of 2 websites.');
        return;
      }

      updateCompareState();
    });
  });
</script>
<script>
  function applyFilters() {
  const selectedStatus = statusFilter.value;
  const sortOrder = sortFilter.value;

  const cards = Array.from(cardsContainer.querySelectorAll('.col'));

  cards.forEach(card => {
    const badge = card.querySelector('.status');
    let show = true;

    if (selectedStatus) {
      if (selectedStatus === 'finished' && !badge.innerText.includes('Finished') && !badge.innerText.includes('游릭')) show = false;
      if (selectedStatus === 'stopped' && !badge.innerText.includes('Stopped') && !badge.innerText.includes('游댮 Stopped')) show = false;
      if (selectedStatus === 'in_progress' && !badge.innerText.includes('In Progress') && !badge.innerText.includes('游리')) show = false;
    }

    if (show) {
      card.classList.remove('hidden');
    } else {
      card.classList.add('hidden');
    }
  });

  const visibleCards = cards.filter(card => !card.classList.contains('hidden'));

  visibleCards.sort((a, b) => {
    const aDate = new Date(a.querySelector('.card-body p.mb-2').innerText.replace('Last Visited:', '').trim());
    const bDate = new Date(b.querySelector('.card-body p.mb-2').innerText.replace('Last Visited:', '').trim());
    return sortOrder === 'asc' ? aDate - bDate : bDate - aDate;
  });

  cardsContainer.innerHTML = '';
  visibleCards.forEach(card => cardsContainer.appendChild(card));
}

</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const statusFilter = document.getElementById('status-filter');
    const sortFilter = document.getElementById('sort-filter');
    const cardsContainer = document.querySelector('.row.row-cols-1');
  
    const allCards = Array.from(cardsContainer.querySelectorAll('.col'));
  
    function applyFilters() {
      const selectedStatus = statusFilter.value;
      const sortOrder = sortFilter.value;
  
      allCards.forEach(card => {
        const badge = card.querySelector('.status');
        let show = true;
  
        if (selectedStatus) {
          if (selectedStatus === 'finished' && !(badge.innerText.includes('Finished') || badge.innerText.includes('游릭'))) show = false;
          if (selectedStatus === 'stopped' && !(badge.innerText.includes('Stopped') || badge.innerText.includes('游댮 Stopped'))) show = false;
          if (selectedStatus === 'in_progress' && !(badge.innerText.includes('In Progress') || badge.innerText.includes('游리'))) show = false;
        }
  
        if (show) {
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      });
  
      const visibleCards = allCards.filter(card => !card.classList.contains('hidden'));
  
      visibleCards.sort((a, b) => {
        const aDate = new Date(a.querySelector('.card-body p.mb-2').innerText.replace('Last Visited:', '').trim());
        const bDate = new Date(b.querySelector('.card-body p.mb-2').innerText.replace('Last Visited:', '').trim());
        return sortOrder === 'asc' ? aDate - bDate : bDate - aDate;
      });
  
      visibleCards.forEach(card => {
        cardsContainer.appendChild(card);
      });
    }
    statusFilter.addEventListener('change', applyFilters);
    sortFilter.addEventListener('change', applyFilters);
  });
</script>
  
  

{% endblock %}